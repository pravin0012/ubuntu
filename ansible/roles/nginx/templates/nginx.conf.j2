# load_module "modules/ngx_http_geoip_module.so";

# user                                    nobody;
# user                                    nginx;
user                                    {{nginx_user}};
worker_processes                        2;
worker_rlimit_nofile                    65536;

error_log                               /var/log/nginx/error.log info;


events {
    worker_connections                  65536;
    use                                 epoll;
}


http {
    include                             mime.types;
    default_type                        application/octet-stream;
    #upload_progress                    proxied 10m;
    #upload_progress                    old 10m;
    #error_page                         404 =302   /error404.php;

    log_format                          combined2 '$remote_addr - $remote_user [$time_local] '
                                        '"$request" $status $body_bytes_sent '
                                        '"$http_referer" "$http_user_agent" $request_time "$geoip_country_code"';

    geoip_country                       /usr/share/GeoIP/GeoIP.dat;
    #geoip_city                         /usr/local/share/GeoIP/GeoLiteCity.dat;
    #sendfile                           on;
    #tcp_nopush                         on;
    gzip                                on;
    gzip_comp_level                     5;
    gzip_min_length                     1024;
    gzip_types                          text/plain application/x-javascript text/css application/xml;
    keepalive_timeout                   300;
    client_max_body_size                4000M;

    index                               index.php index.html index.htm;

    fastcgi_connect_timeout             600;
    fastcgi_send_timeout                600;
    fastcgi_read_timeout                600;
    fastcgi_buffer_size                 256k;
    fastcgi_buffers                     16 256k;
    fastcgi_busy_buffers_size           512k;
    fastcgi_temp_file_write_size        512k;

    #underscores_in_headers              on;

    #include                             vhost/*.conf;

    server {
        listen 80;
        #server_name localhost;
        access_log /var/log/nginx/localhost.access.log;
        error_log /var/log/nginx/localhost.error.log debug;
        root {{nginx_root}};

        location / {
          try_files $uri $uri/ /index.html /index.php?$query_string;
        }

        location ~ \.php$ {
            fastcgi_index  index.php;
            fastcgi_pass unix:/run/php/php7.0-fpm.sock;
            fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
            fastcgi_param  GEOIP_COUNTRY_CODE $geoip_country_code;
            fastcgi_param  GEOIP_COUNTRY_CODE3 $geoip_country_code3;
            fastcgi_param  GEOIP_COUNTRY_NAME $geoip_country_name;
            fastcgi_param  HTTP_X_FILENAME $http_x_tvs_filename;
            include        fastcgi_params;
            include fastcgi_params;
        }
    }
}
